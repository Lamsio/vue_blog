(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{457:function(v,_,t){"use strict";t.r(_);var a=t(4),r=Object(a.a)({},(function(){var v=this,_=v._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[_("h4",{attrs:{id:"简介"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[v._v("#")]),v._v(" 简介")]),v._v(" "),_("p",[v._v("先前学习的是OSPF, RIP等动态路由协议，但这类协议是属于IGP范畴的，也就是说只能应用在区域内，通常城市之间或国家间的路由通信都是采用EGP中的BGP协议。"),_("strong",[v._v("BGP中所有报文都是单播！")])]),v._v(" "),_("h4",{attrs:{id:"as"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#as"}},[v._v("#")]),v._v(" AS")]),v._v(" "),_("p",[v._v("AS自治系统，单一技术管理下的一组网络")]),v._v(" "),_("ul",[_("li",[v._v("16位编号（2009/1起采用32位编号）")]),v._v(" "),_("li",[v._v("1 ~ 65535")]),v._v(" "),_("li",[v._v("私有AS：64512 ~ 65535")])]),v._v(" "),_("p",[v._v("AS号是由IANA机构负责分配的，IGP在AS内运行，AS间通过BGP通信")]),v._v(" "),_("h4",{attrs:{id:"bgp-特点"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp-特点"}},[v._v("#")]),v._v(" BGP 特点")]),v._v(" "),_("p",[v._v("BGP是一种路径矢量协议：")]),v._v(" "),_("ul",[_("li",[v._v("可靠更新：BGP在TCP（port 179）上运行")]),v._v(" "),_("li",[v._v("增量式、触发式更新")]),v._v(" "),_("li",[v._v("定期提供Keepalive信息以验证TCP连接性")]),v._v(" "),_("li",[v._v("丰富的度量标准")]),v._v(" "),_("li",[v._v("专门为大型网络设计")]),v._v(" "),_("li",[_("strong",[v._v("优于距离矢量协议")])])]),v._v(" "),_("h6",{attrs:{id:"使用环境"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#使用环境"}},[v._v("#")]),v._v(" 使用环境")]),v._v(" "),_("ul",[_("li",[v._v("大量路由需要承载，IGP协议通常只能支持千条路由，而BGP可以容纳上万条")]),v._v(" "),_("li",[v._v("支撑MPLS/VPN的应用，传递客户VPN路由")]),v._v(" "),_("li",[v._v("策略能力强，可以很好的实现路由决策和数据控制")]),v._v(" "),_("li")]),v._v(" "),_("h4",{attrs:{id:"bgp报文类型"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp报文类型"}},[v._v("#")]),v._v(" BGP报文类型")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("类型")]),v._v(" "),_("th",[v._v("描述")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("Open")]),v._v(" "),_("td",[v._v("类似HELLO，建立邻居关系")])]),v._v(" "),_("tr",[_("td",[v._v("Keeplive")]),v._v(" "),_("td",[v._v("类似HELLO，维护邻居关系")])]),v._v(" "),_("tr",[_("td",[v._v("Update")]),v._v(" "),_("td",[v._v("路由更新，包含属性")])]),v._v(" "),_("tr",[_("td",[v._v("Notification")]),v._v(" "),_("td",[v._v("当检测到错误、发送后关闭BGP链接")])]),v._v(" "),_("tr",[_("td",[v._v("Route-refresh")]),v._v(" "),_("td",[v._v("当路由策略发生变化时，触发请求邻居重新通告路由")])])])]),v._v(" "),_("h4",{attrs:{id:"bgp链接状态"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp链接状态"}},[v._v("#")]),v._v(" BGP链接状态")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("类型")]),v._v(" "),_("th",[v._v("描述")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("Idle")]),v._v(" "),_("td",[v._v("初始，路由器查找路由表，是否有到达邻居的路由")])]),v._v(" "),_("tr",[_("td",[v._v("Connect")]),v._v(" "),_("td",[v._v("发起TCP链接，等待TCP连接完成")])]),v._v(" "),_("tr",[_("td",[v._v("Active")]),v._v(" "),_("td",[v._v("TCP连接失败，继续尝试TCP连接")])]),v._v(" "),_("tr",[_("td",[v._v("Open Sent")]),v._v(" "),_("td",[v._v("TCP连接成功，已发送OPEN包")])]),v._v(" "),_("tr",[_("td",[v._v("Open Confirm")]),v._v(" "),_("td",[v._v("已收到对方正确的Open包，如果没收到，就会进入Active")])]),v._v(" "),_("tr",[_("td",[v._v("Established")]),v._v(" "),_("td",[v._v("邻居建立完成，开始传递路由")])])])]),v._v(" "),_("h6",{attrs:{id:"状态机"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#状态机"}},[v._v("#")]),v._v(" 状态机")]),v._v(" "),_("p",[_("img",{attrs:{src:"/more/Pasted%20image%2020230114181029.png",alt:"avatar"}}),v._v(" "),_("img",{attrs:{src:"/more/Pasted%20image%2020230114181318.png",alt:"avatar"}})]),v._v(" "),_("h4",{attrs:{id:"bgp邻居"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp邻居"}},[v._v("#")]),v._v(" BGP邻居")]),v._v(" "),_("p",[v._v("BGP Speakers：运行BGP的路由器\nBGP Peers = BGP Neighbors = BGP对等体/邻居\n邻居关系建立在TCP连接基础上，因此邻居不一定需要直连，可以通过IGP或者静态路由的形式提供TCP连接的可达性。（在OSPF中，路由器间要建立OSPF邻居关系则必须是通过物理线缆直连，而BGP的邻居关系可以跨设备建立）\n邻居必须手动指定而非自动建立\n一台BGP路由器只能运行在一个AS内")]),v._v(" "),_("p",[v._v("邻居类型由两种：")]),v._v(" "),_("ol",[_("li",[v._v("IBGP —— 内部BGP邻居，位于相同AS")]),v._v(" "),_("li",[v._v("EBGP —— 外部GBP邻居，位于不同AS")])]),v._v(" "),_("p",[_("img",{attrs:{src:"/more/Pasted%20image%2020230109175828.png",alt:"avatar"}})]),v._v(" "),_("h6",{attrs:{id:"配置命令"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#配置命令"}},[v._v("#")]),v._v(" 配置命令")]),v._v(" "),_("table",[_("thead",[_("tr",[_("th",[v._v("命令")]),v._v(" "),_("th",[v._v("描述")])])]),v._v(" "),_("tbody",[_("tr",[_("td",[v._v("bgp 123")]),v._v(" "),_("td",[v._v("声明设备所在的AS号")])]),v._v(" "),_("tr",[_("td",[v._v("router-id 1.1.1.1")]),v._v(" "),_("td",[v._v("配置RID，必须唯一")])]),v._v(" "),_("tr",[_("td",[v._v("peer 12.0.0.2 as-number 123")]),v._v(" "),_("td",[v._v("配置邻居的IP地址和所在的AS号")])]),v._v(" "),_("tr",[_("td",[v._v("display bgp peer")]),v._v(" "),_("td",[v._v("查看BGP邻居状态")])])])]),v._v(" "),_("h6",{attrs:{id:"bgp邻居建立条件"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp邻居建立条件"}},[v._v("#")]),v._v(" BGP邻居建立条件")]),v._v(" "),_("ul",[_("li",[v._v("邻居地址可达")]),v._v(" "),_("li",[v._v("自身配置中的邻居所在AS号 = 邻居配置中声明的AS号")]),v._v(" "),_("li",[v._v("数据包源IP = 对方配置的邻居IP")])]),v._v(" "),_("h4",{attrs:{id:"bgp邻居建立问题"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp邻居建立问题"}},[v._v("#")]),v._v(" BGP邻居建立问题")]),v._v(" "),_("p",[_("img",{attrs:{src:"/more/Pasted%20image%2020230113202606.png",alt:"avatar"}})]),v._v(" "),_("p",[v._v("假设我们有以上拓扑关系图，通过上述设定会发现，实际上并不能建立BGP邻居关系，因为违反了建立条件，我们通过抓包会发现，无论是"),_("code",[v._v("1.0.0.1")]),v._v("发往"),_("code",[v._v("12.0.0.1")]),v._v("，还是从"),_("code",[v._v("1.0.0.2")]),v._v("发往"),_("code",[v._v("11.0.0.1")]),v._v("，都无法建立关系，因为我们规定了必须是"),_("code",[v._v("12.0.0.1")]),v._v("发往"),_("code",[v._v("11.0.0.1")]),v._v("或者反过来。")]),v._v(" "),_("p",[_("img",{attrs:{src:"/more/Pasted%20image%2020230113202417.png",alt:"avatar"}})]),v._v(" "),_("h6",{attrs:{id:"解决方法"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#解决方法"}},[v._v("#")]),v._v(" 解决方法")]),v._v(" "),_("p",[v._v("上面例子中，我们之所以用回环口而不是物理接口，是因为为了增加稳定性，通常建议使用回环口来建立邻居。")]),v._v(" "),_("p",[v._v("更新源：建立邻居和邻居所学习到的路由的下一跳\n多跳：EBGP邻居建立默认需要直连，因为TTL=1，如果非直连，则必须修改TTL")]),v._v(" "),_("p",[v._v("因此在上面案例中，我们需要在配置邻居命令时增加一条"),_("code",[v._v("peer [邻居IP] con [本机回环口]")])]),v._v(" "),_("p",[_("img",{attrs:{src:"/more/Pasted%20image%2020230113220355.png",alt:"avatar"}})]),v._v(" "),_("p",[v._v("此时，抓包的结果中会发现，源地址和目的地址不再是物理接口与回环口，而是回环口对回环口\n"),_("img",{attrs:{src:"/more/Pasted%20image%2020230113220333.png",alt:"avatar"}})]),v._v(" "),_("h4",{attrs:{id:"跨as建立邻居"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#跨as建立邻居"}},[v._v("#")]),v._v(" 跨AS建立邻居")]),v._v(" "),_("p",[v._v("两台路由不在同一AS中无法使用动态路由协议去实现路由关系，因为动态路由协议是属于IGP的，那么我们只剩下静态路由能使用了。\n"),_("img",{attrs:{src:"/more/Pasted%20image%2020230113205544.png",alt:"avatar"}}),v._v(" "),_("img",{attrs:{src:"/more/Pasted%20image%2020230113211902.png",alt:"avatar"}})]),v._v(" "),_("p",[v._v("当我们尝试用IBGP方式建立邻居时会发现一个现象，抓包的结果全都是红的，而且多了一个"),_("code",[v._v("NOTIFICATION Message")]),v._v("的包，如果你点开这些红色的包会发现，所有TCP的TTL都是1，而且EBGP关系下的路由无法建立邻居关系，这是为什么呢？")]),v._v(" "),_("p",[v._v("因为默认情况下，EBGP邻居的建立是需要直连的，而我们的实验是通过回环口建立的，这意味着当数据包到达目标设备时，TTL已经是0了，因此被丢弃了。因此，我们需要修改TTL的长度从而确保当包抵达目的地时，TTL>1")]),v._v(" "),_("p",[v._v("我们在发送路由上使用"),_("code",[v._v("peer [邻居IP] ebgp-max-hop [TTL number]")])]),v._v(" "),_("h6",{attrs:{id:"bgp-邻居安全"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp-邻居安全"}},[v._v("#")]),v._v(" BGP 邻居安全")]),v._v(" "),_("p",[v._v("通过"),_("code",[v._v("peer [邻居IP] password cipher [密令]")]),v._v("就能设置验证，可以通过抓包发现TCP包的Option项多了一个MD5的字段")]),v._v(" "),_("h4",{attrs:{id:"bgp路由宣告"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp路由宣告"}},[v._v("#")]),v._v(" BGP路由宣告")]),v._v(" "),_("p",[v._v("默认情况下，BGP不发布任何本地路由")]),v._v(" "),_("ul",[_("li",[v._v("只有"),_("strong",[v._v("明确")]),v._v("宣告的网络才会发送给邻居")]),v._v(" "),_("li",[v._v("宣告的网络必须能"),_("strong",[v._v("精确地")]),v._v("再路由表中找到")]),v._v(" "),_("li",[v._v("多条路径时，只选最优的给自己使用")]),v._v(" "),_("li",[v._v("只把自己使用的最优路由告诉邻居")]),v._v(" "),_("li",[v._v("从EBGP学到的路由会宣告给所有邻居")]),v._v(" "),_("li",[v._v("从IBGP学到的路由不会宣告给IBGP")]),v._v(" "),_("li",[v._v("从IBGP学到的路由会宣告给EBGP")])]),v._v(" "),_("p",[v._v("BGP中需要精确地宣告特定路由，也就是说所宣告的路由必须包含在routing-table中，假设有如下路由表\n"),_("img",{attrs:{src:"/more/Pasted%20image%2020230114184520.png",alt:"avatar"}})]),v._v(" "),_("p",[v._v("假设我要宣告"),_("code",[v._v("11.0.0.1/32")]),v._v("，我必须准确宣告"),_("code",[v._v("11.0.0.1/32")]),v._v("或者"),_("code",[v._v("11.0.0.0/24")]),v._v("（包含在路由表中），如果我宣告"),_("code",[v._v("11.0.0.0/8")]),v._v("，就会报错。、")]),v._v(" "),_("p",[v._v("宣告方式分为两种，一种是本地使用"),_("code",[v._v("network")]),v._v("进行宣告，另一种是通过"),_("code",[v._v("import-route")]),v._v("进行宣告。此外我们还能通过"),_("code",[v._v("peer [邻居IP] default-route-advertise")]),v._v("，向邻居宣告一条缺省路由")]),v._v(" "),_("h4",{attrs:{id:"bgp下一跳"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#bgp下一跳"}},[v._v("#")]),v._v(" BGP下一跳")]),v._v(" "),_("ul",[_("li",[v._v("BGP在给邻居传递路由时的下一跳=更新源")]),v._v(" "),_("li",[v._v("在EBGP间传递时会修改下一跳为自己的更新源")]),v._v(" "),_("li",[v._v("在IBGP间传递时不会修改下一跳为自己的更新源")]),v._v(" "),_("li",[_("code",[v._v("peer [邻居IP] next-hop-local")]),v._v(" 修改下一跳为自己的更新源")])]),v._v(" "),_("p",[_("img",{attrs:{src:"/more/Pasted%20image%2020230115175639.png",alt:"avatar"}})]),v._v(" "),_("p",[v._v("从上述案例中可知，当RTC传递路由时，下一跳是"),_("code",[v._v("2.1.1.2")]),v._v("，但当RTB向RTA传递时依旧是"),_("code",[v._v("2.1.1.2")]),v._v("这很明显不合理，因为RTA根本就不知道如何前往"),_("code",[v._v("2.1.1.2")]),v._v("\n我们需要在RTB上输入"),_("code",[v._v("peer 1.1.1.1 next-hop-local")]),v._v("，这样，传递给RTA时，下一跳的地址就会变更为RTB的地址而不是外部的RTC地址。")])])}),[],!1,null,null,null);_.default=r.exports}}]);